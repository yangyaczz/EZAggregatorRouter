const { BigNumber, Signer } = require("ethers");
const { ethers } = require("hardhat");

const nft721ABI = require("./abis/ERC721.json");
const nft1155ABI = require("./abis/ERC1155.json");


describe("aggregator buy nft test", function () {
    let alice;
    let nft;
    let sr;


    let blocknumber = 38193500
    let mockAddress = "0xE3a463d743F762D538031BAD3f1E748BB41f96ec";
    let nftAddress = "0x48c75fbf0452fa8ff2928ddf46b0fe7629cca2ff"
    let tokenid = 7
    // let nftTokenId = "0x5d9cc2b3aefdbe8ec0f69361248e27bfb6c06202:6"

    beforeEach(async () => {

        await network.provider.request({
            method: "hardhat_reset",
            params: [
                {
                    chainId: 137,
                    forking: {
                        jsonRpcUrl: "https://polygon-mainnet.g.alchemy.com/v2/VKUc1_zI9zmEaXNsiDNY0KynQE6rKMsp",
                        blockNumber: blocknumber,
                    },
                },
            ],
        });


        await network.provider.request({
            method: "hardhat_impersonateAccount",
            params: [mockAddress],
        });

        alice = await ethers.provider.getSigner(mockAddress);

        nft = new ethers.Contract(nftAddress, nft1155ABI, alice);

        const paramsConstractorMatic = {
            weth9: "0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270",
            reservoir: "0x819327e005A3ed85F7b634e195b8F25D4a2a45f8",
            seaportModule: "0xb75Dfff7dA2A0c8E6Bb235b80d28f997152D06FC",
            looksRareModule: "0x385df8CBC196f5f780367F3cDC96aF072a916F7E",//
            x2y2Module: "0x613D3c588F6B8f89302b463F8F19f7241B2857E2",//
            sudoswap: "0x2B2e8cDA09bBA9660dCA5cB6233787738Ad68329",//
            ezswap: "0x6D7fBa7979334fC173a42eA8FEF31698318a845A",
        };



        const SR = await ethers.getContractFactory("EZAggregatorV1Router")
        sr = await SR.attach("0x0B1877395d5b4F93A677cB13544b0061Ee45e8A3")

        //////////////////////
    });

    it("buy nft through simpleRouter", async () => {

        console.log(await ethers.provider.getBlockNumber())
        console.log(
            "taker address is:",
            alice._address,
            "relayer address is:",
            sr.address
        );

        console.log(
            "before execute taker nft balance:",
            await nft.balanceOf(alice._address, tokenid),
            "before execute relayer nft balance:",
            await nft.balanceOf(sr.address, tokenid)
        );
        ///


        ////////
        // await alice.sendTransaction({
        //     "to": "0x819327e005a3ed85f7b634e195b8f25d4a2a45f8",
        //     "data": "0x760f2a0b000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000e225afd0b78a265a60ccaeb1c1310e0016716e7b0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000006a94d74f43000000000000000000000000000000000000000000000000000000000000000006a476af662900000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000e3a463d743f762d538031bad3f1e748bb41f96ec000000000000000000000000e3a463d743f762d538031bad3f1e748bb41f96ec0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000006a94d74f430000000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000063000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000bbb155379ae1de8fdd82a73aa1dab8cc6502dd4600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000063c68a9c0000000000000000000000000000000000000000000000000000000063ef691c0000000000000000000000000000000000000000000000000000000000000000360c6ebe0000000000000000000000000000000000000000ecc8e3a76ec425620000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000000048c75fbf0452fa8ff2928ddf46b0fe7629cca2ff000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000630000000000000000000000000000000000000000000000000000000000000063000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024109d5b320be00000000000000000000000000000000000000000000000000024109d5b320be000000000000000000000000000bbb155379ae1de8fdd82a73aa1dab8cc6502dd460000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000107c9fb4a92a0000000000000000000000000000000000000000000000000000107c9fb4a92a0000000000000000000000000000000a26b00c1f0df003000390027140000faa719000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041f27ed2a4a8000000000000000000000000000000000000000000000000000041f27ed2a4a8000000000000000000000000000fde55ee5b8c137fd3a0e5d55b6fff58995bb4636000000000000000000000000000000000000000000000000000000000000004147287ec930ea64e8ab3c186835fc53843f5d65e9b78b9a29858b2c8e884611e622502b83f98d4ad66a0d427e76c916212cf5d2ea2232f927fd243f62671101171c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        //     "value": "0x6a94d74f430000"
        // })

        // await alice.sendTransaction({
        //     "to": "0x0000000000000000000000000000000000000000",
        //     "data": "0x760f2a0b000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000e225afd0b78a265a60ccaeb1c1310e0016716e7b0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000006a94d74f43000000000000000000000000000000000000000000000000000000000000000006a476af662900000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000e3a463d743f762d538031bad3f1e748bb41f96ec000000000000000000000000e3a463d743f762d538031bad3f1e748bb41f96ec0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000006a94d74f430000000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000063000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000bbb155379ae1de8fdd82a73aa1dab8cc6502dd4600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000063c68a9c0000000000000000000000000000000000000000000000000000000063ef691c0000000000000000000000000000000000000000000000000000000000000000360c6ebe0000000000000000000000000000000000000000ecc8e3a76ec425620000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000000048c75fbf0452fa8ff2928ddf46b0fe7629cca2ff000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000630000000000000000000000000000000000000000000000000000000000000063000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024109d5b320be00000000000000000000000000000000000000000000000000024109d5b320be000000000000000000000000000bbb155379ae1de8fdd82a73aa1dab8cc6502dd460000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000107c9fb4a92a0000000000000000000000000000000000000000000000000000107c9fb4a92a0000000000000000000000000000000a26b00c1f0df003000390027140000faa719000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041f27ed2a4a8000000000000000000000000000000000000000000000000000041f27ed2a4a8000000000000000000000000000fde55ee5b8c137fd3a0e5d55b6fff58995bb4636000000000000000000000000000000000000000000000000000000000000004147287ec930ea64e8ab3c186835fc53843f5d65e9b78b9a29858b2c8e884611e622502b83f98d4ad66a0d427e76c916212cf5d2ea2232f927fd243f62671101171c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        //     "value": "0x6a94d74f430000"
        // })

        // let gas = await ethers.provider.estimateGas({
        //     "from": "0xe3a463d743f762d538031bad3f1e748bb41f96ec",
        //     "to": "0x819327e005a3ed85f7b634e195b8f25d4a2a45f8",
        //     "data": "0x760f2a0b000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000e225afd0b78a265a60ccaeb1c1310e0016716e7b0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000006a94d74f43000000000000000000000000000000000000000000000000000000000000000006a476af662900000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000e3a463d743f762d538031bad3f1e748bb41f96ec000000000000000000000000e3a463d743f762d538031bad3f1e748bb41f96ec0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000006a94d74f430000000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000063000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000bbb155379ae1de8fdd82a73aa1dab8cc6502dd4600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000063c68a9c0000000000000000000000000000000000000000000000000000000063ef691c0000000000000000000000000000000000000000000000000000000000000000360c6ebe0000000000000000000000000000000000000000ecc8e3a76ec425620000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000000048c75fbf0452fa8ff2928ddf46b0fe7629cca2ff000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000630000000000000000000000000000000000000000000000000000000000000063000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024109d5b320be00000000000000000000000000000000000000000000000000024109d5b320be000000000000000000000000000bbb155379ae1de8fdd82a73aa1dab8cc6502dd460000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000107c9fb4a92a0000000000000000000000000000000000000000000000000000107c9fb4a92a0000000000000000000000000000000a26b00c1f0df003000390027140000faa719000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041f27ed2a4a8000000000000000000000000000000000000000000000000000041f27ed2a4a8000000000000000000000000000fde55ee5b8c137fd3a0e5d55b6fff58995bb4636000000000000000000000000000000000000000000000000000000000000004147287ec930ea64e8ab3c186835fc53843f5d65e9b78b9a29858b2c8e884611e622502b83f98d4ad66a0d427e76c916212cf5d2ea2232f927fd243f62671101171c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        //     "value": "0x6a94d74f430000"
        // })

        // console.log(gas)


        //////


        // opensea
        let dataApi = {
            "from": "0x0b1877395d5b4f93a677cb13544b0061ee45e8a3",
            "to": "0x819327e005a3ed85f7b634e195b8f25d4a2a45f8",
            "data": "0x760f2a0b000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000e225afd0b78a265a60ccaeb1c1310e0016716e7b0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000006a94d74f43000000000000000000000000000000000000000000000000000000000000000006a476af662900000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000e3a463d743f762d538031bad3f1e748bb41f96ec000000000000000000000000e3a463d743f762d538031bad3f1e748bb41f96ec0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000006a94d74f430000000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000063000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000bbb155379ae1de8fdd82a73aa1dab8cc6502dd4600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000063c68a9c0000000000000000000000000000000000000000000000000000000063ef691c0000000000000000000000000000000000000000000000000000000000000000360c6ebe0000000000000000000000000000000000000000ecc8e3a76ec425620000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000000048c75fbf0452fa8ff2928ddf46b0fe7629cca2ff000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000630000000000000000000000000000000000000000000000000000000000000063000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024109d5b320be00000000000000000000000000000000000000000000000000024109d5b320be000000000000000000000000000bbb155379ae1de8fdd82a73aa1dab8cc6502dd460000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000107c9fb4a92a0000000000000000000000000000000000000000000000000000107c9fb4a92a0000000000000000000000000000000a26b00c1f0df003000390027140000faa719000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041f27ed2a4a8000000000000000000000000000000000000000000000000000041f27ed2a4a8000000000000000000000000000fde55ee5b8c137fd3a0e5d55b6fff58995bb4636000000000000000000000000000000000000000000000000000000000000004147287ec930ea64e8ab3c186835fc53843f5d65e9b78b9a29858b2c8e884611e622502b83f98d4ad66a0d427e76c916212cf5d2ea2232f927fd243f62671101171c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "value": "0x6a94d74f430000"
          }

        let input;

        if (dataApi.to == "0x819327e005a3ed85f7b634e195b8f25d4a2a45f8") {
            input = ethers.utils.defaultAbiCoder.encode(
                ["uint256", "bytes"],
                [dataApi.value, dataApi.data]
            );
        } else {
            console.log("offerMarketId error");
            return;
        }

        await sr['execute(bytes,bytes[],uint256)']('0x00', [input], 2000000000, { value: dataApi.value });

        console.log(
            "after execute taker nft balance:",
            await nft.balanceOf(alice._address, tokenid),
            "after execute relayer nft balance:",
            await nft.balanceOf(sr.address, tokenid)
        );
    });
});
