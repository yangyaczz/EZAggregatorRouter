const { BigNumber, Signer } = require("ethers");
const { ethers } = require("hardhat");

const nftABI = require("./abis/ERC721.json");
const wethABI = require("./abis/WETH.json");

const seaportABI = require("./abis/Seaport.json")
const conduitABI = require("./abis/Conduit.json")


describe("aggregator sell nft mulit test", function () {
    let alice;
    let nft;
    let sr;

    let seaport;
    let conduit;

    beforeEach(async () => {
        const mockAddress = "0x64C362d2fF237f44C8a774A973984886dBd9B21D";
        await network.provider.request({
            method: "hardhat_impersonateAccount",
            params: [mockAddress],
        });

        await network.provider.send("hardhat_setBalance", [
            "0x64C362d2fF237f44C8a774A973984886dBd9B21D",
            '0x1d6329f1c35ca4bfabb9f560ffffffffff'
        ]);

        alice = await ethers.provider.getSigner(mockAddress);
        ////////////////////////

        seaport = new ethers.Contract("0x00000000006c3852cbef3e08e8df289169ede581", seaportABI, alice)
        conduit = new ethers.Contract("0x1e0049783f008a0085193e00003d00cd54003c71", conduitABI, alice)


        ////////////




        const nftAddress = "0x67D9417C9C3c250f61A83C7e8658daC487B56B09";
        nft = new ethers.Contract(nftAddress, nftABI, alice);

        const wethAddress = "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2";
        weth = new ethers.Contract(wethAddress, wethABI, alice);



        const SR = await ethers.getContractFactory("EZAggregatorV1Router")

        sr = await SR.attach("0xac3e3114784b46a8b201c07B69Db87BBCDbc9179")

        //////////////////////
    });

    it("sell nft through simpleRouter", async () => {


        console.log(
            "taker address is:",
            alice._address,
            "relayer address is:",
            sr.address
        );

        console.log(
            "before execute taker nft balance:",
            await nft.balanceOf(alice._address),
            "before execute relayer nft balance:",
            await nft.balanceOf(sr.address)
        );


        console.log(
            "cheak offer maker status:",
            await weth.balanceOf("0xb095d9f608d77b95f3ce175ba3cd63534750d60c"),
            await weth.allowance("0xb095d9f608d77b95f3ce175ba3cd63534750d60c", "0x1e0049783f008a0085193e00003d00cd54003c71")
        );

        ////////////////////////////////// 1 get from api



        let tansferAmount = ethers.BigNumber.from("10000000000000000000")

        await weth.connect(alice).deposit({ value: tansferAmount })

        await weth.connect(alice).transfer("0x21C8e614CD5c37765411066D2ec09912020c846F", tansferAmount)



        const dataApi1 = "0xb88d4fde000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000613d3c588f6b8f89302b463f8f19f7241b2857e20000000000000000000000000000000000000000000000000000000000001b8f00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000964760f2a0b000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000613d3c588f6b8f89302b463f8f19f7241b2857e2000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000864f2ec5c5200000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000008400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000002aec180a9c890000000000000000000000000000000000000000000000000000000063bbf9e200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000613d3c588f6b8f89302b463f8f19f7241b2857e200000000000000000000000000000000000000000000000000000000000000008231db0ba8c2645757b8db8f9ee33aac66fa530d6e6a21ffb7c031081ac23fbb5bbe4ee35e8a9f085936cacbad834c7ecee4b1652c2c82f39875249a8c262e22000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000f461a402a662dde21478c2764549d609000000000000000000000000aa2f597552dc6350195995f4845b882f81d4122f00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000644abacc000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000240518596b5c5f5e59c0b465fbc2c7ff2ea1683e3ddae9e604fb147908196cfb22b514eaa76220bcbab5196d6608ecdc16d2c62ed6463ba9716f89ac7ac3a48780b000000000000000000000000000000000000000000000000000000000000001b00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000002386f26fc10000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000067d9417c9c3c250f61a83c7e8658dac487b56b09000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc100002aa983b889bdac6849ec240cdc2a259d350c26f67df7642ad75887a315786410000000000000000000000000f849de01b080adc3a814fabe1e2087475cf2e3540000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000067d9417c9c3c250f61a83c7e8658dac487b56b090000000000000000000000000000000000000000000000000000000000001b8f00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000001388000000000000000000000000d823c605807cc5e6bd6fc0d7e4eea50d3e2d66cd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        const offerAmount1 = "9200000000000000"


        const dataApi2 = "0xb88d4fde000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc91790000000000000000000000003729014ef28f01b3ddcf7f980d925e0b71b1f8470000000000000000000000000000000000000000000000000000000000001b8f000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000009a4760f2a0b0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003729014ef28f01b3ddcf7f980d925e0b71b1f8470000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a46baab5f700000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000005c0000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc91790000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000088000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000046000000000000000000000000000000000000000000000000000000000000004e0000000000000000000000000b095d9f608d77b95f3ce175ba3cd63534750d60c000000000000000000000000004c00500000ad104d7dbd00e3ae0a5c00560c000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000063b97d940000000000000000000000000000000000000000000000000000000063b984c90000000000000000000000000000000000000000000000000000000000000000a6ceae3433de155ff15effe45edc68ae51b97346fac4332751ed171bb865fe9e0000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003d6a6e99bb8460000000000000000000000000000000000000000000000000003d6a6e99bb846000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000067d9417c9c3c250f61a83c7e8658dac487b56b099965876021f7738a5a3132b4587c0703067c6fe6e9011cb66ff871f53c09c67200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b095d9f608d77b95f3ce175ba3cd63534750d60c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001890f90a4b01c0000000000000000000000000000000000000000000000000001890f90a4b01c00000000000000000000000000000a26b00c1f0df003000390027140000faa7190000000000000000000000000000000000000000000000000000000000000041fc2eadef8b73b662d5e2ed5469b5e2faee2380239b3a166e8b7db91869956baf1fb62669220885bb95cda3d090475fa23770b7c1b1d55c57712f2545642ad1681b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001b8f00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000e375af38c615bc3b651d74d7d59974b82de2cfc350734166de4356711f3dca129fb21861f515e0cbe986bafde33432861b3a0cf20be62d678f92143e20722abd12eb30580e7e7f54ccbdc7f8287b70ba4a58d851adb5b06fb711034914c302ed9831e651f85ba5a53f74afd0e8c6c23ddd67b9a63f727e659363c32f005e128f3ed2175958356f7553305cf6741a47c46a92990b4690bbc531e8a2db36dd6f5f8d56ae188453e91a01525f9d0145509a233c23076f5ac53d6320565a64fddfa3bed23ba5cd5feb95184985e1ac3effa9ff03cebbcbb13ced834b86783630f87b2c2a97b89d622990f06cf4c0db37b11fa06687f45c459dedd16e098d542cc7b2354a691cec3e12b96ab7b05ab4c153e01d4c60a769855c9756dd2c04da172af695e0dc73aa7e0164427697376f122684363a1fe8c9d047a9f57bccad5b74c7bcf12c43ef40ddb884c6d5c3623c8f6673ed3bcbfce9dba1d623498974dade0afef72bc72f15720a92b285fcc40c247dd2029087e260f8122ef2ce03f8516099374a47e838b3ef91bbcf32fd6b525fad03c1be84e3f6f659bc5804a6259141902d38d41dc10f4b775fb64acbb16141b980b1530e99fc45150a2b7856c1c7ac1816f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        const offerAmount2 = "269677150665000000"

        // const dataApi3 = "0xb88d4fde000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc91790000000000000000000000003729014ef28f01b3ddcf7f980d925e0b71b1f8470000000000000000000000000000000000000000000000000000000000001b8f000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000008e4760f2a0b0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003729014ef28f01b3ddcf7f980d925e0b71b1f8470000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007e46baab5f700000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000500000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000007c000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000004200000000000000000000000005ed7be27722ed1ffb7fff525557d83692d981d9c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000063b96c730000000000000000000000000000000000000000000000000000000063b988cf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001d4da48b78d71d7d55ff17ca78b88b7032290000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c767684456c00000000000000000000000000000000000000000000000000003c767684456c0000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000400000000000000000000000067d9417c9c3c250f61a83c7e8658dac487b56b0970335ca23d065a0abb8df3cd1bd8627d2ecd41bd1884ab4dd5fc5dd40e61562c000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000005ed7be27722ed1ffb7fff525557d83692d981d9c00000000000000000000000000000000000000000000000000000000000000419955f21d3efd9ca8aa772e9f350edf41a677f6f53943baead2c66302439cd57f3c4278d8be46f8d38709f9c6617a863f7ff3c15dd1a39e28f29ea81f438c3d6e1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001b8f00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000e375fda8a07876d54709b5ae39ebf334d6d8170114778711771e9bfd400ca95bed09641e33f87697141c48968eaed511771a37fd9974225a1c73bb221a3ee66daf018567e456d64773e4412852293b2e1eca452f57749a9e1cf01701c15aa170820be52f40a43c8cbed3b3ef0a8d8c70ce3847dadc1c445ad74c97fc23d102019f2ce3768572174e9ed78c6749022713181c719557bd068c82dc169521f4e1a6716b7b9091875fde95ef3924791619bfda34fd481e3e5fb5415d1013a55897017c173e624dc3ec25db807ef7d6fb5be87e8d3da872ca42028ecf0b4696fafcbad5937ed4cb758b2aaf3fffa020c4f36e23772d31f5ac8b0e26dfadfffe76da262d8f21aa2275b28ba6f047306413eb38e0944313843d6bf2fff57533e85172e48140faede08089716bdd9f0905f969771f6765f48cad3bba1a5f4bfba3ea51744ff039b25ce93113c48b333729a0d3bd30fdc334b1290d0fc6fc48f6afee679ea28530c5d63458b3a31810e541d7b30dcc8d2bb1b3502a8e220eb995e31db4cf52496ed27137a3ff44fc8506f0cf50f0bce4b2c486d5acd3266b66cb0dd887f1a660d086be26ed9e655c989144d7a23158618a0acaf100bfcd2d98476515c344500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        // const offerAmount3 = "272300000000000000"


        const dataApis = [dataApi1]
        const collections = ["0x67D9417C9C3c250f61A83C7e8658daC487B56B09"]
        const offerAmounts = [offerAmount1]



        ///////////////////// 2 encode date

        let ReservoirOffers = [];

        for (let i = 0; i < dataApis.length; i++) {

            const decode = hre.ethers.utils.defaultAbiCoder.decode(
                ["address", "address", "uint256", "bytes"],
                ethers.utils.hexDataSlice(dataApis[i], 4)
            );

            let offerMarketId;
            if (decode[1] == "0x3729014ef28f01B3ddCF7f980D925E0B71b1F847") {
                offerMarketId = 0;
            } else if (decode[1] == "0x385df8CBC196f5f780367F3cDC96aF072a916F7E") {
                offerMarketId = 1;
            } else if (decode[1] == "0x613D3c588F6B8f89302b463F8F19f7241B2857E2") {
                offerMarketId = 2;
            } else {
                return;
            }

            const ReservoirOffer = {
                offerMarket: offerMarketId,
                tokenStandard: 721, // erc721 is fixed
                collection: collections[i], // api
                tokenId: decode[2],
                tokenAmount: 1, // erc721 is fixed
                inputDate: decode[3],
                offerAmount: offerAmounts[i], // api
            };


            ReservoirOffers.push(ReservoirOffer);

        }




        ///////////////////////////////   3  send tx
        let input = ethers.utils.defaultAbiCoder.encode(
            [
                "(uint8 offerMarket, uint256 tokenStandard, address collection,uint256 tokenId, uint256 tokenAmount, bytes inputDate, uint256 offerAmount)[]",
            ],
            [ReservoirOffers]
        );


        await nft.setApprovalForAll(sr.address, true);

        await sr.connect(alice)["execute(bytes,bytes[],uint256)"]("0x01", [input], 2000000000);

        console.log(
            "after execute taker nft balance:",
            await nft.balanceOf(alice._address),
            "after execute relayer nft balance:",
            await nft.balanceOf(sr.address),
            "after execute relayer weth balance:",
            await weth.balanceOf(sr.address),
        );
    });
});
