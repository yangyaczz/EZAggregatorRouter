const { BigNumber, Signer } = require("ethers");
const { ethers } = require("hardhat");

const nftABI = require("./abis/ERC721.json");
const wethABI = require("./abis/WETH.json");


describe("aggregator sell nft mulit test", function () {
    let alice;
    let nft;
    let sr;

    beforeEach(async () => {
        const mockAddress = "0xE3a463d743F762D538031BAD3f1E748BB41f96ec";
        await network.provider.request({
            method: "hardhat_impersonateAccount",
            params: [mockAddress],
        });

        await network.provider.send("hardhat_setBalance", [
            "0xE3a463d743F762D538031BAD3f1E748BB41f96ec",
            '0x1d6329f1c35ca4bfabb9f560ffffffffff'
        ]);

        alice = await ethers.provider.getSigner(mockAddress);

        const nftAddress = "0x72583175813213a8ed175c6dcc82aea5b0ba6db6";
        nft = new ethers.Contract(nftAddress, nftABI, alice);

        const wethAddress = "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2";
        weth = new ethers.Contract(wethAddress, wethABI, alice);

        const paramsConstractorMainnet = {
            weth9: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
            reservoir: "0x178A86D36D89c7FDeBeA90b739605da7B131ff6A",
            seaportModule: "0x3729014ef28f01B3ddCF7f980D925E0B71b1F847",
            looksRareModule: "0x385df8CBC196f5f780367F3cDC96aF072a916F7E",
            x2y2Module: "0x613D3c588F6B8f89302b463F8F19f7241B2857E2",
            sudoswap: "0x2B2e8cDA09bBA9660dCA5cB6233787738Ad68329",
            ezswap: "0xa63eC144d070a1BF19a7577C88c580E7de92E0fc",
        };

        const SR = await ethers.getContractFactory("EZAggregatorV1Router")

        sr = await SR.attach("0xac3e3114784b46a8b201c07B69Db87BBCDbc9179")

        //////////////////////
    });

    it("sell nft through simpleRouter", async () => {
        console.log(
            "taker address is:",
            alice._address,
            "relayer address is:",
            sr.address
        );

        console.log(
            "before execute taker nft balance:",
            await nft.balanceOf(alice._address),
            "before execute relayer nft balance:",
            await nft.balanceOf(sr.address)
        );


        ////////////////////////////////// 1 get from api

        // orderId: "0x36d482ac2b0c189b13ec69515a42284f31db3598b5c8c40164e71937c136e7c6",    // x2y2 
        // taker: "0xac3e3114784b46a8b201c07B69Db87BBCDbc9179",
        // token: "0x72583175813213a8ed175c6dcc82aea5b0ba6db6:0",

        // orderId: "0x9b9fefa14df023f4094f5eb903737c95f5da7787bcc3e8b2ae0fd4aae6976c7c",   //look
        // taker: "0xac3e3114784b46a8b201c07B69Db87BBCDbc9179",
        // token: "0x72583175813213a8ed175c6dcc82aea5b0ba6db6:1",

        // orderId: "0x98a472a3fab05d685f8ec6ad77c5efc2b038e90c93e0110bc86ce93fddb330a6",   // x2y2
        // taker: "0xac3e3114784b46a8b201c07B69Db87BBCDbc9179",
        // token: "0x72583175813213a8ed175c6dcc82aea5b0ba6db6:2",

        let tansferAmount = ethers.BigNumber.from("10000000000000000000")

        await weth.connect(alice).deposit({value:tansferAmount})

        // await weth.connect(alice).transfer("0x21C8e614CD5c37765411066D2ec09912020c846F", tansferAmount)



        const dataApi1 = "0xb88d4fde000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000613d3c588f6b8f89302b463f8f19f7241b2857e2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000964760f2a0b000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000613d3c588f6b8f89302b463f8f19f7241b2857e2000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000864f2ec5c5200000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc917900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000dd0606a774d70000000000000000000000000000000000000000000000000000000063b7f95a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000613d3c588f6b8f89302b463f8f19f7241b2857e20000000000000000000000000000000000000000000000000000000000000000e0b1eacae61c3e97c6d38cdbe85a462a17139c1400d9a611bb7e66c98825d50452eb5e1b803b573384c322a3a3484a4ce1d61cdf88d129d1dfa11fd904a452ba000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000f1794ec199677cb9c241dbbb8af7c51100000000000000000000000021c8e614cd5c37765411066d2ec09912020c846f0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000063d78b8a000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000024001d8c7841f0b0e54a17e1ad5e6a4bfece095fb48c00e1ddc499bbbdd7342eb0d4ece91cef3b75e0e39b2f24a12142b74cc1fd372a82a89ba2be339298e4c586c000000000000000000000000000000000000000000000000000000000000001b000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000027147114878000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000072583175813213a8ed175c6dcc82aea5b0ba6db6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002714711487800036d482ac2b0c189b13ec69515a42284f31db3598b5c8c40164e71937c136e7c6000000000000000000000000f849de01b080adc3a814fabe1e2087475cf2e3540000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000072583175813213a8ed175c6dcc82aea5b0ba6db6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000001388000000000000000000000000d823c605807cc5e6bd6fc0d7e4eea50d3e2d66cd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"

        const dataApi2 = "0xb88d4fde000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000385df8cbc196f5f780367f3cdc96af072a916f7e0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000004e4760f2a0b000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000385df8cbc196f5f780367f3cdc96af072a916f7e0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003e4267bf79700000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000385df8cbc196f5f780367f3cdc96af072a916f7e000000000000000000000000000000000000000000000000002386f26fc100000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000264800000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021c8e614cd5c37765411066d2ec09912020c846f00000000000000000000000072583175813213a8ed175c6dcc82aea5b0ba6db6000000000000000000000000000000000000000000000000002386f26fc100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000009f93623019049c76209c26517acc2af9d49c69b000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000063b65daf0000000000000000000000000000000000000000000000000000000063ddea9b00000000000000000000000000000000000000000000000000000000000026480000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001c1911a37b21ea5876ff8973aae5cbf5af184cd6615070ed481e22ca03fa08ca9631485421a12443bce264a6e7ec87480615a2c22c88e5db925e9ffcac6468282c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"

        const dataApi3 = "0xb88d4fde000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000613d3c588f6b8f89302b463f8f19f7241b2857e2000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000964760f2a0b000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000613d3c588f6b8f89302b463f8f19f7241b2857e2000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000864f2ec5c5200000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000ac3e3114784b46a8b201c07b69db87bbcdbc9179000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000008400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000018e652e18a9fb0000000000000000000000000000000000000000000000000000000063b7fc7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000613d3c588f6b8f89302b463f8f19f7241b2857e2000000000000000000000000000000000000000000000000000000000000000086515ab474bba41eec23a172fdc484d83fa3bccae4f7be2408995f293de7f7a0441e4525df3de5ca56ead21f2d9ba4117c8f4468465bb5084614e32dfa1a09e2000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000850bd6fd5b5549af957efa2f3d9ae5bb00000000000000000000000021c8e614cd5c37765411066d2ec09912020c846f0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000063ddea7d000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002406157db9e7d7bd970517833943817e4efadb9b357fb652b4a9c6b8f0f737ef5682f45fa5ce8a1e1526bbc96c3c367b06417b10c369a50ed285cd8b06ecdb52131000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000001550f7dca70000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000072583175813213a8ed175c6dcc82aea5b0ba6db6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001550f7dca7000098a472a3fab05d685f8ec6ad77c5efc2b038e90c93e0110bc86ce93fddb330a6000000000000000000000000f849de01b080adc3a814fabe1e2087475cf2e3540000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000072583175813213a8ed175c6dcc82aea5b0ba6db6000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000001388000000000000000000000000d823c605807cc5e6bd6fc0d7e4eea50d3e2d66cd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"

        const dataApis = [dataApi1, dataApi2, dataApi3]
        const collections = ["0x72583175813213a8ed175c6dcc82aea5b0ba6db6", "0x72583175813213a8ed175c6dcc82aea5b0ba6db6", "0x72583175813213a8ed175c6dcc82aea5b0ba6db6"]
        const offerAmounts = ["10945000000000000", "9850000000000000", "5970000000000000"]


        // const dataApis = [dataApi2, dataApi3]
        // const collections = ["0x72583175813213a8ed175c6dcc82aea5b0ba6db6", "0x72583175813213a8ed175c6dcc82aea5b0ba6db6"]
        // const offerAmounts = ["9850000000000000", "5970000000000000"]



        ///////////////////// 2 encode date

        let ReservoirOffers = [];

        for (let i = 0; i < dataApis.length; i++) {

            const decode = hre.ethers.utils.defaultAbiCoder.decode(
                ["address", "address", "uint256", "bytes"],
                ethers.utils.hexDataSlice(dataApis[i], 4)
            );

            let offerMarketId;
            if (decode[1] == "0x3729014ef28f01B3ddCF7f980D925E0B71b1F847") {
                offerMarketId = 0;
            } else if (decode[1] == "0x385df8CBC196f5f780367F3cDC96aF072a916F7E") {
                offerMarketId = 1;
            } else if (decode[1] == "0x613D3c588F6B8f89302b463F8F19f7241B2857E2") {
                offerMarketId = 2;
            } else {
                return;
            }

            const ReservoirOffer = {
                offerMarket: offerMarketId,
                tokenStandard: 721, // erc721 is fixed
                collection: collections[i], // api
                tokenId: decode[2],
                tokenAmount: 1, // erc721 is fixed
                inputDate: decode[3],
                offerAmount: offerAmounts[i], // api
            };


            ReservoirOffers.push(ReservoirOffer);

        }




        ///////////////////////////////   3  send tx
        let input = ethers.utils.defaultAbiCoder.encode(
            [
                "(uint8 offerMarket, uint256 tokenStandard, address collection,uint256 tokenId, uint256 tokenAmount, bytes inputDate, uint256 offerAmount)[]",
            ],
            [ReservoirOffers]
        );


        await nft.setApprovalForAll(sr.address, true);
        await sr.connect(alice)["execute(bytes,bytes[],uint256)"]("0x01", [input], 2000000000);

        console.log(
            "after execute taker nft balance:",
            await nft.balanceOf(alice._address),
            "after execute relayer nft balance:",
            await nft.balanceOf(sr.address),
            "after execute relayer weth balance:",
            await weth.balanceOf(sr.address),
        );
    });
});
